{% extends "baseTemplate.html" %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
/* ===========================
   UI: A√±os -> Trimestres (scoped)
   =========================== */
.year-wrap{
  --y-bg: #f6f8fb;
  --y-card: #ffffff;
  --y-text: #0f172a;
  --y-muted: #64748b;
  --y-border: rgba(226, 232, 240, .9);
  --y-shadow: 0 1px 2px rgba(0,0,0,.05), 0 24px 48px -24px rgba(0,0,0,.18);
  --y-radius: 16px;
  --y-grad: linear-gradient(90deg, #3A6284 20%, #28455E 100%);
  --y-grad-soft: linear-gradient(90deg, rgba(58,98,132,.12) 0%, rgba(40,69,94,.06) 100%);
  background: var(--y-bg);
  padding: 20px;
  border-radius: 18px;
}

/* HERO */
.year-hero{
  background: var(--y-card);
  border: 1px solid var(--y-border);
  border-radius: var(--y-radius);
  box-shadow: var(--y-shadow);
  padding: 18px;
  position: relative;
  overflow: hidden;
}
.year-hero::before{
  content:'';
  position:absolute; inset:0;
  background: var(--y-grad-soft);
  pointer-events:none;
}
.year-hero-inner{
  position: relative;
  display:flex;
  flex-wrap: wrap;
  gap: 14px;
  align-items:center;
  justify-content: space-between;
}
.year-title{
  display:flex;
  flex-direction:column;
  gap: 6px;
  min-width: 240px;
}
.year-title h2{
  margin:0;
  font-weight: 900;
  color: var(--y-text);
}
.year-title p{
  margin:0;
  color: var(--y-muted);
  font-size: 13px;
}

.year-actions{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
}
.year-btn{
  border: none;
  border-radius: 12px;
  padding: 11px 14px;
  font-weight: 800;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration:none !important;
}
.year-btn-primary{
  color: #fff !important;
  background: var(--y-grad);
  box-shadow: 0 10px 20px -12px rgba(40, 69, 94, .6);
}
.year-btn-primary:hover{ opacity:.95; transform: translateY(-1px); }

.year-search{
  position: relative;
  min-width: 240px;
  flex: 1;
  max-width: 420px;
}
.year-search input{
  width:100%;
  border: 1px solid var(--y-border);
  border-radius: 14px;
  padding: 11px 14px 11px 40px;
  outline: none;
  background: rgba(255,255,255,.95);
  transition: box-shadow .2s ease, border-color .2s ease;
}
.year-search input:focus{
  border-color: rgba(58,98,132,.55);
  box-shadow: 0 0 0 4px rgba(58,98,132,.12);
}
.year-search i{
  position:absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #94a3b8;
}
.year-select{
  border: 1px solid var(--y-border);
  border-radius: 14px;
  padding: 11px 14px;
  background: rgba(255,255,255,.95);
  outline: none;
  min-width: 170px;
}
@media (max-width:768px){
  .year-actions{ width:100%; }
  .year-search{ max-width:100%; min-width: 100%; }
  .year-select{ min-width: 100%; }
}

/* Card */
.year-card{
  margin-top: 16px;
  background: var(--y-card);
  border: 1px solid var(--y-border);
  border-radius: var(--y-radius);
  box-shadow: var(--y-shadow);
  overflow: hidden;
}
.year-card-topbar{ height: 4px; background: var(--y-grad); }
.year-card-header{
  padding: 14px 16px;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  border-bottom: 1px solid var(--y-border);
}
.year-card-header .left{
  display:flex; align-items:center; gap: 10px;
}
.year-card-header .left i{ color: #3A6284; }
.year-card-header h4{
  margin:0;
  font-weight: 900;
  color: var(--y-text);
  font-size: 15px;
}
.year-chip{
  border-radius: 999px;
  padding: 7px 10px;
  font-size: 12px;
  font-weight: 800;
  background: #f8fafc;
  border: 1px solid var(--y-border);
  color: var(--y-muted);
}

/* Accordion buttons */
.acc-btn{
  background: #fff !important;
  border: 1px solid var(--y-border) !important;
  border-radius: 14px !important;
  padding: 14px 14px !important;
  color: var(--y-text) !important;
  font-weight: 900 !important;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  box-shadow: 0 10px 25px -22px rgba(0,0,0,.25);
}
.acc-btn .left{
  display:flex; align-items:center; gap: 10px; min-width: 0;
}
.acc-btn .badge{
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 900;
  background: rgba(58,98,132,.10);
  border: 1px solid rgba(58,98,132,.18);
  color: #28455E;
  white-space: nowrap;
}

.q-wrap{ padding: 0 10px 12px 10px; }
.q-item{ margin: 10px 0; }
.q-btn{
  background: #f8fafc !important;
  border: 1px solid rgba(226, 232, 240, .95) !important;
  border-radius: 14px !important;
  padding: 12px 14px !important;
  color: #0f172a !important;
  font-weight: 900 !important;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.q-btn .left{ display:flex; align-items:center; gap: 10px; min-width: 0; }
.q-pill{
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 900;
  background: rgba(245,158,11,.12);
  border: 1px solid rgba(245,158,11,.22);
  color: #92400e;
}

/* List items */
.year-list{
  list-style:none;
  margin:0;
  padding: 8px 0 0 0;
}
.year-item{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 12px;
  margin: 10px 0;
  border-radius: 14px;
  border: 1px solid var(--y-border);
  background: #fff;
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.year-item:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 24px -18px rgba(0,0,0,.28);
  border-color: rgba(148,163,184,.55);
}
.year-left{
  display:flex;
  align-items:flex-start;
  gap: 12px;
  min-width: 0;
}
.year-icon{
  width: 42px;
  height: 42px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background: #f1f5f9;
  color: #64748b;
  font-size: 16px;
  flex: 0 0 auto;
}
.year-meta{
  display:flex;
  flex-direction:column;
  gap: 6px;
  min-width: 0;
}
.file-title{
  font-weight: 900;
  color: var(--y-text);
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 520px;
}
@media (max-width: 768px){ .file-title{ max-width: 240px; } }
.subline{
  color: var(--y-muted);
  font-size: 12px;
  display:flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items:center;
}
.badge-soft{
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 900;
  border: 1px solid var(--y-border);
  background: #f8fafc;
  color: #0f172a;
  white-space: nowrap;
}
.badge-soft.link{
  background: rgba(59,130,246,.10);
  border-color: rgba(59,130,246,.22);
  color: #1d4ed8;
}
.badge-soft.file{
  background: rgba(16,185,129,.10);
  border-color: rgba(16,185,129,.22);
  color: #065f46;
}
.badge-soft.q{
  background: rgba(245,158,11,.12);
  border-color: rgba(245,158,11,.22);
  color: #92400e;
}
.badge-soft.na{
  background: rgba(100,116,139,.12);
  border-color: rgba(100,116,139,.18);
  color: #334155;
  opacity: .9;
}

/* action buttons */
.year-icons{
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}
.year-iconbtn{
  width: 42px;
  height: 42px;
  border-radius: 12px;
  display:flex;
  align-items:center;
  justify-content:center;
  border: 1px solid var(--y-border);
  background: #fff;
  transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
  cursor:pointer;
  text-decoration:none !important;
}
.year-iconbtn:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 18px -14px rgba(0,0,0,.25);
}
.year-iconbtn i{ font-size: 16px; }
.year-iconbtn.open i{ color: #0ea5e9; }
.year-iconbtn.edit i{ color: #f59e0b; }
.year-iconbtn.delete{
  background: rgba(220,53,69,.08);
  border-color: rgba(220,53,69,.18);
}
.year-iconbtn.delete i{ color: #dc3545; }

/* helpers */
.empty-box{
  margin:10px 0;
  padding:12px;
  border-radius:14px;
  border: 1px dashed rgba(226,232,240,.95);
  background:#fff;
  color:#94a3b8;
  text-align:center;
  font-weight:800;
  font-size: 13px;
}
</style>

<div class="container-fluid year-wrap">

  <!-- HERO -->
  <div class="year-hero">
    <div class="year-hero-inner">
      <div class="year-title">
        <h2>üóÇÔ∏è Registros (A√±o ‚Üí Trimestre)</h2>
        <p>
          Lista: <strong>{{ articulo.lista_obligaciones.titulo }}</strong> ‚Ä¢
          Fracci√≥n: <strong>{{ articulo.articulo_fraccion }}</strong>
        </p>
      </div>

      <div class="year-actions">
        <select id="yearSelect" class="year-select" onchange="applyFilters()">
          <option value="">Todos los a√±os</option>
          {% for ano, archivos in articulos_por_ano.items %}
            <option value="{{ ano }}">{{ ano }}</option>
          {% endfor %}
        </select>

        <div class="year-search">
          <i class="fas fa-search"></i>
          <input id="searchInput" type="text"
                 placeholder="Buscar: t√≠tulo, trimestre, liga/archivo‚Ä¶"
                 onkeyup="applyFilters()">
        </div>

        <a href="{% url 'crear_articulo_liga' articulo.id %}" class="year-btn year-btn-primary">
          <i class="fas fa-plus"></i> Crear registro
        </a>
      </div>
    </div>
  </div>

  <!-- CARD -->
  <div class="year-card">
    <div class="year-card-topbar"></div>

    <div class="year-card-header">
      <div class="left">
        <i class="fas fa-list"></i>
        <h4>Documentos / ligas por a√±o y trimestre</h4>
      </div>
      <span class="year-chip">Todo colapsado ‚Ä¢ abre por a√±o y trimestre</span>
    </div>

    <div class="accordion" id="yearsAccordion" style="padding: 12px 12px 16px;">

      {% for ano, archivos in articulos_por_ano.items %}
        <div class="accordion-item year-acc-item" data-year="{{ ano }}" style="border:none; background:transparent; margin-bottom: 10px;">
          <h2 class="accordion-header" id="headingYear{{ ano }}">
            <button class="accordion-button collapsed acc-btn"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseYear{{ ano }}"
                    aria-expanded="false"
                    aria-controls="collapseYear{{ ano }}">
              <span class="left">
                <i class="fas fa-folder-open" style="color:#3A6284;"></i>
                <span style="white-space:nowrap;">A√±o {{ ano }}</span>
                <span class="badge">{{ archivos|length }} registro(s)</span>
              </span>
              <span style="font-size:12px; color:#94a3b8; font-weight:800;">Click para expandir</span>
            </button>
          </h2>

          <div id="collapseYear{{ ano }}" class="accordion-collapse collapse"
               aria-labelledby="headingYear{{ ano }}"
               data-bs-parent="#yearsAccordion">
            <div class="accordion-body" style="padding: 0; margin-top: 10px;">

              <div class="accordion q-wrap" id="quartersAccordion{{ ano }}">

                {# ====== TRIMESTRE 1 ====== #}
                <div class="accordion-item q-item quarter-acc-item" data-year="{{ ano }}" data-quarter="1" style="border:none; background:transparent;">
                  <h2 class="accordion-header" id="headingQ{{ ano }}_1">
                    <button class="accordion-button collapsed q-btn" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseQ{{ ano }}_1"
                            aria-expanded="false"
                            aria-controls="collapseQ{{ ano }}_1">
                      <span class="left">
                        <i class="fas fa-layer-group" style="color:#f59e0b;"></i>
                        <span>Trimestre 1</span>
                        <span class="q-pill">T1</span>
                      </span>
                      <span style="font-size:12px; color:#94a3b8; font-weight:800;">Ver</span>
                    </button>
                  </h2>

                  <div id="collapseQ{{ ano }}_1" class="accordion-collapse collapse"
                       aria-labelledby="headingQ{{ ano }}_1"
                       data-bs-parent="#quartersAccordion{{ ano }}">
                    <div class="accordion-body" style="padding: 0 6px 6px 6px;">
                      <ul class="year-list">
                        {% for archivo_info in archivos %}
                          {% if archivo_info.archivo.trimestre == 1 %}
                            <li class="year-item articulo-item"
                                data-year="{{ ano }}"
                                data-quarter="1"
                                data-text="{{ ano }} t1 trimestre 1 {{ archivo_info.archivo.titulo_archivo|default_if_none:''|lower }} {{ archivo_info.tipo|lower }}">
                              <div class="year-left">
                                <div class="year-icon">
                                  {% if archivo_info.tipo == 'liga' %}<i class="fas fa-link"></i>{% else %}<i class="fas fa-file-alt"></i>{% endif %}
                                </div>
                                <div class="year-meta">
                                  <div class="file-title" title="{{ archivo_info.archivo.titulo_archivo|default:'(Sin t√≠tulo)' }}">
                                    {{ archivo_info.archivo.titulo_archivo|default:"(Sin t√≠tulo)" }}
                                  </div>
                                  <div class="subline">
                                    <span class="badge-soft">{{ ano }}</span>
                                    <span class="badge-soft q"><i class="fas fa-layer-group"></i> T1</span>
                                    {% if archivo_info.tipo == 'liga' %}
                                      <span class="badge-soft link"><i class="fas fa-link"></i> Liga</span>
                                    {% else %}
                                      <span class="badge-soft file"><i class="fas fa-file"></i> Archivo</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>

                              <div class="year-icons">
                                {% if archivo_info.tipo == 'liga' %}
                                  {% if archivo_info.archivo and archivo_info.archivo.liga %}
                                    <a href="{{ archivo_info.archivo.liga }}" class="year-iconbtn open" title="Abrir liga" target="_blank" rel="noopener">
                                      <i class="fas fa-link"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay enlace</span>
                                  {% endif %}
                                {% else %}
                                  {% if archivo_info.archivo and archivo_info.archivo.archivo %}
                                    <a href="{{ archivo_info.archivo.archivo.url }}" class="year-iconbtn open" title="Ver documento" target="_blank" rel="noopener">
                                      <i class="fas fa-file-pdf"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay archivo</span>
                                  {% endif %}
                                {% endif %}

                                <a href="{% url 'editar_articulo_liga' archivo_info.archivo.id %}" class="year-iconbtn edit" title="Editar">
                                  <i class="fas fa-edit"></i>
                                </a>

                                <button class="year-iconbtn delete eliminar-articulo"
                                        data-id="{{ archivo_info.archivo.id }}"
                                        data-ano="{{ archivo_info.archivo.ano }}"
                                        title="Eliminar">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </div>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                      <div class="empty-box" data-empty="q1">Sin registros en Trimestre 1.</div>
                    </div>
                  </div>
                </div>

                {# ====== TRIMESTRE 2 ====== #}
                <div class="accordion-item q-item quarter-acc-item" data-year="{{ ano }}" data-quarter="2" style="border:none; background:transparent;">
                  <h2 class="accordion-header" id="headingQ{{ ano }}_2">
                    <button class="accordion-button collapsed q-btn" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseQ{{ ano }}_2"
                            aria-expanded="false"
                            aria-controls="collapseQ{{ ano }}_2">
                      <span class="left">
                        <i class="fas fa-layer-group" style="color:#f59e0b;"></i>
                        <span>Trimestre 2</span>
                        <span class="q-pill">T2</span>
                      </span>
                      <span style="font-size:12px; color:#94a3b8; font-weight:800;">Ver</span>
                    </button>
                  </h2>

                  <div id="collapseQ{{ ano }}_2" class="accordion-collapse collapse"
                       aria-labelledby="headingQ{{ ano }}_2"
                       data-bs-parent="#quartersAccordion{{ ano }}">
                    <div class="accordion-body" style="padding: 0 6px 6px 6px;">
                      <ul class="year-list">
                        {% for archivo_info in archivos %}
                          {% if archivo_info.archivo.trimestre == 2 %}
                            <li class="year-item articulo-item"
                                data-year="{{ ano }}"
                                data-quarter="2"
                                data-text="{{ ano }} t2 trimestre 2 {{ archivo_info.archivo.titulo_archivo|default_if_none:''|lower }} {{ archivo_info.tipo|lower }}">
                              <div class="year-left">
                                <div class="year-icon">
                                  {% if archivo_info.tipo == 'liga' %}<i class="fas fa-link"></i>{% else %}<i class="fas fa-file-alt"></i>{% endif %}
                                </div>
                                <div class="year-meta">
                                  <div class="file-title" title="{{ archivo_info.archivo.titulo_archivo|default:'(Sin t√≠tulo)' }}">
                                    {{ archivo_info.archivo.titulo_archivo|default:"(Sin t√≠tulo)" }}
                                  </div>
                                  <div class="subline">
                                    <span class="badge-soft">{{ ano }}</span>
                                    <span class="badge-soft q"><i class="fas fa-layer-group"></i> T2</span>
                                    {% if archivo_info.tipo == 'liga' %}
                                      <span class="badge-soft link"><i class="fas fa-link"></i> Liga</span>
                                    {% else %}
                                      <span class="badge-soft file"><i class="fas fa-file"></i> Archivo</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>

                              <div class="year-icons">
                                {% if archivo_info.tipo == 'liga' %}
                                  {% if archivo_info.archivo and archivo_info.archivo.liga %}
                                    <a href="{{ archivo_info.archivo.liga }}" class="year-iconbtn open" title="Abrir liga" target="_blank" rel="noopener">
                                      <i class="fas fa-link"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay enlace</span>
                                  {% endif %}
                                {% else %}
                                  {% if archivo_info.archivo and archivo_info.archivo.archivo %}
                                    <a href="{{ archivo_info.archivo.archivo.url }}" class="year-iconbtn open" title="Ver documento" target="_blank" rel="noopener">
                                      <i class="fas fa-file-pdf"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay archivo</span>
                                  {% endif %}
                                {% endif %}

                                <a href="{% url 'editar_articulo_liga' archivo_info.archivo.id %}" class="year-iconbtn edit" title="Editar">
                                  <i class="fas fa-edit"></i>
                                </a>

                                <button class="year-iconbtn delete eliminar-articulo"
                                        data-id="{{ archivo_info.archivo.id }}"
                                        data-ano="{{ archivo_info.archivo.ano }}"
                                        title="Eliminar">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </div>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                      <div class="empty-box" data-empty="q2">Sin registros en Trimestre 2.</div>
                    </div>
                  </div>
                </div>

                {# ====== TRIMESTRE 3 ====== #}
                <div class="accordion-item q-item quarter-acc-item" data-year="{{ ano }}" data-quarter="3" style="border:none; background:transparent;">
                  <h2 class="accordion-header" id="headingQ{{ ano }}_3">
                    <button class="accordion-button collapsed q-btn" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseQ{{ ano }}_3"
                            aria-expanded="false"
                            aria-controls="collapseQ{{ ano }}_3">
                      <span class="left">
                        <i class="fas fa-layer-group" style="color:#f59e0b;"></i>
                        <span>Trimestre 3</span>
                        <span class="q-pill">T3</span>
                      </span>
                      <span style="font-size:12px; color:#94a3b8; font-weight:800;">Ver</span>
                    </button>
                  </h2>

                  <div id="collapseQ{{ ano }}_3" class="accordion-collapse collapse"
                       aria-labelledby="headingQ{{ ano }}_3"
                       data-bs-parent="#quartersAccordion{{ ano }}">
                    <div class="accordion-body" style="padding: 0 6px 6px 6px;">
                      <ul class="year-list">
                        {% for archivo_info in archivos %}
                          {% if archivo_info.archivo.trimestre == 3 %}
                            <li class="year-item articulo-item"
                                data-year="{{ ano }}"
                                data-quarter="3"
                                data-text="{{ ano }} t3 trimestre 3 {{ archivo_info.archivo.titulo_archivo|default_if_none:''|lower }} {{ archivo_info.tipo|lower }}">
                              <div class="year-left">
                                <div class="year-icon">
                                  {% if archivo_info.tipo == 'liga' %}<i class="fas fa-link"></i>{% else %}<i class="fas fa-file-alt"></i>{% endif %}
                                </div>
                                <div class="year-meta">
                                  <div class="file-title" title="{{ archivo_info.archivo.titulo_archivo|default:'(Sin t√≠tulo)' }}">
                                    {{ archivo_info.archivo.titulo_archivo|default:"(Sin t√≠tulo)" }}
                                  </div>
                                  <div class="subline">
                                    <span class="badge-soft">{{ ano }}</span>
                                    <span class="badge-soft q"><i class="fas fa-layer-group"></i> T3</span>
                                    {% if archivo_info.tipo == 'liga' %}
                                      <span class="badge-soft link"><i class="fas fa-link"></i> Liga</span>
                                    {% else %}
                                      <span class="badge-soft file"><i class="fas fa-file"></i> Archivo</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>

                              <div class="year-icons">
                                {% if archivo_info.tipo == 'liga' %}
                                  {% if archivo_info.archivo and archivo_info.archivo.liga %}
                                    <a href="{{ archivo_info.archivo.liga }}" class="year-iconbtn open" title="Abrir liga" target="_blank" rel="noopener">
                                      <i class="fas fa-link"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay enlace</span>
                                  {% endif %}
                                {% else %}
                                  {% if archivo_info.archivo and archivo_info.archivo.archivo %}
                                    <a href="{{ archivo_info.archivo.archivo.url }}" class="year-iconbtn open" title="Ver documento" target="_blank" rel="noopener">
                                      <i class="fas fa-file-pdf"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay archivo</span>
                                  {% endif %}
                                {% endif %}

                                <a href="{% url 'editar_articulo_liga' archivo_info.archivo.id %}" class="year-iconbtn edit" title="Editar">
                                  <i class="fas fa-edit"></i>
                                </a>

                                <button class="year-iconbtn delete eliminar-articulo"
                                        data-id="{{ archivo_info.archivo.id }}"
                                        data-ano="{{ archivo_info.archivo.ano }}"
                                        title="Eliminar">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </div>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                      <div class="empty-box" data-empty="q3">Sin registros en Trimestre 3.</div>
                    </div>
                  </div>
                </div>

                {# ====== TRIMESTRE 4 ====== #}
                <div class="accordion-item q-item quarter-acc-item" data-year="{{ ano }}" data-quarter="4" style="border:none; background:transparent;">
                  <h2 class="accordion-header" id="headingQ{{ ano }}_4">
                    <button class="accordion-button collapsed q-btn" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseQ{{ ano }}_4"
                            aria-expanded="false"
                            aria-controls="collapseQ{{ ano }}_4">
                      <span class="left">
                        <i class="fas fa-layer-group" style="color:#f59e0b;"></i>
                        <span>Trimestre 4</span>
                        <span class="q-pill">T4</span>
                      </span>
                      <span style="font-size:12px; color:#94a3b8; font-weight:800;">Ver</span>
                    </button>
                  </h2>

                  <div id="collapseQ{{ ano }}_4" class="accordion-collapse collapse"
                       aria-labelledby="headingQ{{ ano }}_4"
                       data-bs-parent="#quartersAccordion{{ ano }}">
                    <div class="accordion-body" style="padding: 0 6px 6px 6px;">
                      <ul class="year-list">
                        {% for archivo_info in archivos %}
                          {% if archivo_info.archivo.trimestre == 4 %}
                            <li class="year-item articulo-item"
                                data-year="{{ ano }}"
                                data-quarter="4"
                                data-text="{{ ano }} t4 trimestre 4 {{ archivo_info.archivo.titulo_archivo|default_if_none:''|lower }} {{ archivo_info.tipo|lower }}">
                              <div class="year-left">
                                <div class="year-icon">
                                  {% if archivo_info.tipo == 'liga' %}<i class="fas fa-link"></i>{% else %}<i class="fas fa-file-alt"></i>{% endif %}
                                </div>
                                <div class="year-meta">
                                  <div class="file-title" title="{{ archivo_info.archivo.titulo_archivo|default:'(Sin t√≠tulo)' }}">
                                    {{ archivo_info.archivo.titulo_archivo|default:"(Sin t√≠tulo)" }}
                                  </div>
                                  <div class="subline">
                                    <span class="badge-soft">{{ ano }}</span>
                                    <span class="badge-soft q"><i class="fas fa-layer-group"></i> T4</span>
                                    {% if archivo_info.tipo == 'liga' %}
                                      <span class="badge-soft link"><i class="fas fa-link"></i> Liga</span>
                                    {% else %}
                                      <span class="badge-soft file"><i class="fas fa-file"></i> Archivo</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>

                              <div class="year-icons">
                                {% if archivo_info.tipo == 'liga' %}
                                  {% if archivo_info.archivo and archivo_info.archivo.liga %}
                                    <a href="{{ archivo_info.archivo.liga }}" class="year-iconbtn open" title="Abrir liga" target="_blank" rel="noopener">
                                      <i class="fas fa-link"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay enlace</span>
                                  {% endif %}
                                {% else %}
                                  {% if archivo_info.archivo and archivo_info.archivo.archivo %}
                                    <a href="{{ archivo_info.archivo.archivo.url }}" class="year-iconbtn open" title="Ver documento" target="_blank" rel="noopener">
                                      <i class="fas fa-file-pdf"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay archivo</span>
                                  {% endif %}
                                {% endif %}

                                <a href="{% url 'editar_articulo_liga' archivo_info.archivo.id %}" class="year-iconbtn edit" title="Editar">
                                  <i class="fas fa-edit"></i>
                                </a>

                                <button class="year-iconbtn delete eliminar-articulo"
                                        data-id="{{ archivo_info.archivo.id }}"
                                        data-ano="{{ archivo_info.archivo.ano }}"
                                        title="Eliminar">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </div>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                      <div class="empty-box" data-empty="q4">Sin registros en Trimestre 4.</div>
                    </div>
                  </div>
                </div>

                {# ====== SIN TRIMESTRE (opcional) ====== #}
                <div class="accordion-item q-item quarter-acc-item" data-year="{{ ano }}" data-quarter="0" style="border:none; background:transparent;">
                  <h2 class="accordion-header" id="headingQ{{ ano }}_0">
                    <button class="accordion-button collapsed q-btn" type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseQ{{ ano }}_0"
                            aria-expanded="false"
                            aria-controls="collapseQ{{ ano }}_0">
                      <span class="left">
                        <i class="fas fa-inbox" style="color:#64748b;"></i>
                        <span>Sin trimestre</span>
                        <span class="q-pill" style="background:rgba(100,116,139,.12); border-color:rgba(100,116,139,.18); color:#334155;">N/A</span>
                      </span>
                      <span style="font-size:12px; color:#94a3b8; font-weight:800;">Ver</span>
                    </button>
                  </h2>

                  <div id="collapseQ{{ ano }}_0" class="accordion-collapse collapse"
                       aria-labelledby="headingQ{{ ano }}_0"
                       data-bs-parent="#quartersAccordion{{ ano }}">
                    <div class="accordion-body" style="padding: 0 6px 6px 6px;">
                      <ul class="year-list">
                        {% for archivo_info in archivos %}
                          {% if not archivo_info.archivo.trimestre %}
                            <li class="year-item articulo-item"
                                data-year="{{ ano }}"
                                data-quarter="0"
                                data-text="{{ ano }} sin trimestre {{ archivo_info.archivo.titulo_archivo|default_if_none:''|lower }} {{ archivo_info.tipo|lower }}">
                              <div class="year-left">
                                <div class="year-icon">
                                  {% if archivo_info.tipo == 'liga' %}<i class="fas fa-link"></i>{% else %}<i class="fas fa-file-alt"></i>{% endif %}
                                </div>
                                <div class="year-meta">
                                  <div class="file-title" title="{{ archivo_info.archivo.titulo_archivo|default:'(Sin t√≠tulo)' }}">
                                    {{ archivo_info.archivo.titulo_archivo|default:"(Sin t√≠tulo)" }}
                                  </div>
                                  <div class="subline">
                                    <span class="badge-soft">{{ ano }}</span>
                                    <span class="badge-soft na"><i class="fas fa-layer-group"></i> Sin trimestre</span>
                                    {% if archivo_info.tipo == 'liga' %}
                                      <span class="badge-soft link"><i class="fas fa-link"></i> Liga</span>
                                    {% else %}
                                      <span class="badge-soft file"><i class="fas fa-file"></i> Archivo</span>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>

                              <div class="year-icons">
                                {% if archivo_info.tipo == 'liga' %}
                                  {% if archivo_info.archivo and archivo_info.archivo.liga %}
                                    <a href="{{ archivo_info.archivo.liga }}" class="year-iconbtn open" title="Abrir liga" target="_blank" rel="noopener">
                                      <i class="fas fa-link"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay enlace</span>
                                  {% endif %}
                                {% else %}
                                  {% if archivo_info.archivo and archivo_info.archivo.archivo %}
                                    <a href="{{ archivo_info.archivo.archivo.url }}" class="year-iconbtn open" title="Ver documento" target="_blank" rel="noopener">
                                      <i class="fas fa-file-pdf"></i>
                                    </a>
                                  {% else %}
                                    <span class="text-muted" style="font-size:12px;">No hay archivo</span>
                                  {% endif %}
                                {% endif %}

                                <a href="{% url 'editar_articulo_liga' archivo_info.archivo.id %}" class="year-iconbtn edit" title="Editar">
                                  <i class="fas fa-edit"></i>
                                </a>

                                <button class="year-iconbtn delete eliminar-articulo"
                                        data-id="{{ archivo_info.archivo.id }}"
                                        data-ano="{{ archivo_info.archivo.ano }}"
                                        title="Eliminar">
                                  <i class="fas fa-trash-alt"></i>
                                </button>
                              </div>
                            </li>
                          {% endif %}
                        {% endfor %}
                      </ul>
                      <div class="empty-box" data-empty="q0">Sin registros sin trimestre.</div>
                    </div>
                  </div>
                </div>

              </div><!-- quartersAccordion -->

            </div>
          </div>
        </div>
      {% empty %}
        <div class="alert alert-warning text-center mb-0" style="margin: 10px 16px;">
          No hay registros disponibles.
        </div>
      {% endfor %}

    </div><!-- yearsAccordion -->
  </div><!-- card -->
</div>

<br>

<script>
/* ===========================
   FILTROS: a√±o + buscador
   - Oculta a√±os sin resultados
   - Oculta trimestres sin resultados
   - Auto-expande coincidencias (solo cuando filtras/buscas)
   =========================== */
function applyFilters(){
  const year = document.getElementById('yearSelect').value;
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();

  const items = Array.from(document.querySelectorAll('.articulo-item'));
  let found = 0;

  // 1) filtra items
  items.forEach(item => {
    const itemYear = item.dataset.year || '';
    const text = (item.dataset.text || '').toLowerCase();

    const yearOk = !year || itemYear === year;
    const textOk = !q || text.includes(q);
    const visible = yearOk && textOk;

    item.style.display = visible ? '' : 'none';
    if (visible) found++;
  });

  // 2) trimestres: visibles?
  document.querySelectorAll('.quarter-acc-item').forEach(block => {
    const visibles = Array.from(block.querySelectorAll('.articulo-item'))
      .some(li => getComputedStyle(li).display !== 'none');

    block.style.display = visibles ? '' : 'none';

    // empty msg on/off
    const emptyMsg = block.querySelector('[data-empty]');
    if (emptyMsg) emptyMsg.style.display = visibles ? 'none' : '';

    // auto-open trimestre si filtrando/buscando
    const collapse = block.querySelector('.accordion-collapse');
    const btn = block.querySelector('.accordion-button');
    if (collapse && btn){
      const shouldOpen = visibles && (q || year);
      if (shouldOpen){
        collapse.classList.add('show');
        btn.classList.remove('collapsed');
        btn.setAttribute('aria-expanded','true');
      }else{
        collapse.classList.remove('show');
        btn.classList.add('collapsed');
        btn.setAttribute('aria-expanded','false');
      }
    }
  });

  // 3) a√±os: visibles?
  document.querySelectorAll('.year-acc-item').forEach(yBlock => {
    const y = yBlock.dataset.year || '';
    const visibles = Array.from(yBlock.querySelectorAll('.quarter-acc-item'))
      .some(el => getComputedStyle(el).display !== 'none');

    yBlock.style.display = visibles ? '' : 'none';

    const collapse = yBlock.querySelector('.accordion-collapse');
    const btn = yBlock.querySelector('.accordion-button');
    if (collapse && btn){
      if (year){
        // si hay a√±o seleccionado => abre solo ese
        if (y === year && visibles){
          collapse.classList.add('show');
          btn.classList.remove('collapsed');
          btn.setAttribute('aria-expanded','true');
        }else{
          collapse.classList.remove('show');
          btn.classList.add('collapsed');
          btn.setAttribute('aria-expanded','false');
        }
      }else{
        // si hay b√∫squeda => abre a√±os con coincidencias
        const shouldOpen = visibles && q;
        if (shouldOpen){
          collapse.classList.add('show');
          btn.classList.remove('collapsed');
          btn.setAttribute('aria-expanded','true');
        }else{
          // todo colapsado por defecto
          collapse.classList.remove('show');
          btn.classList.add('collapsed');
          btn.setAttribute('aria-expanded','false');
        }
      }
    }
  });

  // 4) no resultados global
  let noResultados = document.getElementById('noResultados');
  if (found === 0) {
    if (!noResultados) {
      noResultados = document.createElement('div');
      noResultados.id = 'noResultados';
      noResultados.className = 'alert alert-secondary text-center';
      noResultados.style.margin = '10px 16px';
      noResultados.textContent = 'No se encontraron registros que coincidan con la b√∫squeda.';
      document.querySelector('.year-card').appendChild(noResultados);
    }
  } else {
    if (noResultados) noResultados.remove();
  }
}

document.addEventListener('DOMContentLoaded', applyFilters);
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
/* Delete */
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".eliminar-articulo").forEach(button => {
    button.addEventListener("click", function() {
      const articuloId = this.getAttribute("data-id");
      const articuloNombre = this.getAttribute("data-ano");

      Swal.fire({
        title: "üóëÔ∏è Eliminar Documento o Enlace",
        html: `
          <p>Se eliminar√° el enlace o documento relacionado al a√±o <strong>${articuloNombre}</strong>.</p>
          <p><strong>Esta acci√≥n no se puede deshacer.</strong></p>
          <p>¬øDeseas continuar?</p>
        `,
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "S√≠, eliminar",
        cancelButtonText: "Cancelar"
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/eliminar_articulo_liga/${articuloId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/x-www-form-urlencoded"
            }
          }).then(r => r.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  title: "¬°Eliminado!",
                  text: data.message,
                  icon: "success",
                  timer: 1800,
                  showConfirmButton: false
                }).then(() => window.location.reload());
              } else {
                Swal.fire("Error", "No se pudo eliminar. Intenta de nuevo.", "error");
              }
            }).catch(() => Swal.fire("Error", "Ocurri√≥ un error. Intenta de nuevo.", "error"));
        }
      });
    });
  });
});
</script>

{% endblock %}
