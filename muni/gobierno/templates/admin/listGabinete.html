{% extends "baseTemplate.html" %}
{% load static %}

{% block content %}

<style>
    .btn-add {
        display: block;
        margin-bottom: 20px;
        background-color: #3E688C;
        color: white;
        border-radius: 10px;
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        width: 25%;
    }

    .btn-add:hover {
        background-color: rgb(20, 102, 149);
        color: white;
    }

    .dashboard {
        display: grid !important;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)) !important;
        gap: 3rem !important;
        width: 100% !important;
        margin-bottom: 60px;
    }
    
    .cardash {
        background: white !important;
        border-radius: 1rem !important;
        padding: 1.5rem !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05), 0 20px 40px -20px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid rgba(241, 245, 249, 0.8) !important;
        transition: transform 0.3s ease, box-shadow 0.3s ease !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    .cardash:hover {
        transform: translateY(-4px) !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 25px 50px -12px rgba(0, 0, 0, 0.1) !important;
    }
    
    .cardash::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: 4px !important;
        background: linear-gradient(90deg, #6366f1 0%, #a855f7 50%, #ec4899 100%) !important;
    }
    
    .cardash-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 1.5rem !important;
    }
    
    .cardash-title {
        font-size: 1rem !important;
        font-weight: 600 !important;
        color: #64748b !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
    }
    
    .cardash-icon {
        width: 48px !important;
        height: 48px !important;
        border-radius: 0.75rem !important;
        background: #f1f5f9 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: all 0.3s ease !important;
        font-size: 1.5rem !important;
    }
    
    .cardash-content {
        max-height: 100px; /* Ajusta la altura seg√∫n lo que necesites */
        overflow-y: auto; /* Activa el scroll si el contenido excede la altura */
        padding-right: 8px; /* Espacio para evitar que el scroll tape el contenido */
        padding-top: 4px; /* A√±adir un peque√±o padding superior */
        scroll-padding-top: 10px; /* Ayuda a que el primer elemento no quede oculto */
    }

</style>

<!-- CSS personalizado -->
<style>
    .sortable-table tr {
        cursor: grab;
        transition: background-color 0.2s;
    }
    
    .sortable-table tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .sortable-table tr.sortable-ghost {
        background-color: #f8f9fa;
        opacity: 0.8;
    }
    
    .sortable-table tr.sortable-chosen {
        background-color: #e9ecef;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
    }
    
    .drag-handle {
        cursor: grab;
        color: #6c757d;
    }
    
    .drag-handle:hover {
        color: #0d6efd;
    }
    
    .drag-hint {
        font-size: 0.9rem;
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    .fade-out {
        animation: fadeOut 2s forwards;
        animation-delay: 3s;
    }
</style>

<style>
  .action-icon { color:#6c757d; text-decoration:none; }
  .action-icon:hover { color:#0d6efd; }
</style>


<div class="container-fluid mt-5">

  <div class="dashboard">
    <div class="row">
      <!-- Principales -->
      <div class="col-12 col-sm-4 col-md-4 col-lg-4 mt-2">
        <div class="cardash">
          <div class="cardash-header">
            <span class="cardash-title">Principales</span>
            <div class="cardash-icon">
              <span class="emoji-transition">üìÅ</span>
            </div>
          </div>
          <div class="cardash-content" style="font-size: 30px;">
            {{ contacts_data.gabinete }}
          </div>
        </div>
      </div>

      <!-- Regidores -->
      <div class="col-12 col-sm-4 col-md-4 col-lg-4 mt-2">
        <div class="cardash">
          <div class="cardash-header">
            <span class="cardash-title">Regidores</span>
            <div class="cardash-icon">
              <span class="emoji-transition">üìÅ</span>
            </div>
          </div>
          <div class="cardash-content" style="font-size: 30px;">
            {{ contacts_data.regidores }}
          </div>
        </div>
      </div>

      <!-- Directores -->
      <div class="col-12 col-sm-4 col-md-4 col-lg-4 mt-2">
        <div class="cardash">
          <div class="cardash-header">
            <span class="cardash-title">Directores</span>
            <div class="cardash-icon">
              <span class="emoji-transition">üìÅ</span>
            </div>
          </div>
          <div class="cardash-content" style="font-size: 30px;">
            {{ contacts_data.directores }}
          </div>
        </div>
      </div>

      <!-- Presidentes Comunales -->
      <div class="col-12 col-sm-4 col-md-4 col-lg-4 mt-2">
        <div class="cardash">
          <div class="cardash-header">
            <span class="cardash-title">Presidentes de Comunidad</span>
            <div class="cardash-icon">
              <span class="emoji-transition">üèòÔ∏è</span>
            </div>
          </div>
          <div class="cardash-content" style="font-size: 30px;">
            {{ contacts_data.presidentes_comu }}
          </div>
        </div>
      </div>

      <!-- Coordinadores DIF -->
      <div class="col-12 col-sm-4 col-md-4 col-lg-4 mt-2">
        <div class="cardash">
          <div class="cardash-header">
            <span class="cardash-title">Coordinadores DIF</span>
            <div class="cardash-icon">
              <span class="emoji-transition">ü§ù</span>
            </div>
          </div>
          <div class="cardash-content" style="font-size: 30px;">
            {{ contacts_data.coordinadores_dif }}
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="row">
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <a href="{% url 'gabinete_create' %}" class="btn btn-add w-100" style="margin-bottom: 20px; border-radius: 10px; padding: 12px 20px; font-size: 16px;">
        <i class="fa fa-user-plus"></i> Agregar miembros principales
      </a>
    </div>
  </div>

  <!-- PRINCIPALES -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Miembros Principales</h2>
      <div class="drag-hint">
        <i class="fa fa-info-circle me-2"></i>
        <span>Arrastra las filas para reorganizar</span>
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="gabineteTable">
          <thead class="table-light">
            <tr>
              <th class="border-0">Nombre</th>
              <th class="border-0">Cargo</th>
              <th class="border-0">√Årea</th>
              <th class="border-0">Estado</th>
              <th class="border-0 text-center">Posici√≥n</th>
              <th class="border-0 text-center">Usuario</th> <!-- NUEVO -->
              <th class="border-0 text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="gabineteTableBody" class="sortable-table">
            <!-- Filas din√°micas -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-footer text-muted">
      <div id="statusMessage" class="text-center"></div>
    </div>
  </div>


  <!-- Bot√≥n Regidor -->
  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
    <a href="{% url 'regidor_create' %}" class="btn btn-add w-100 mb-3">
      <i class="fa fa-user-plus"></i> Agregar regidor
    </a>
  </div>

  <!-- REGIDORES -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Regidores</h2>
      <div class="drag-hint">
        <i class="fa fa-info-circle me-2"></i>
        <span>Arrastra las filas para reorganizar</span>
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="regidoresTable">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Cargo</th>
              <th>√Årea</th>
              <th>Estado</th>
              <th class="text-center">Posici√≥n</th>
              <th class="text-center">Usuario</th> <!-- NUEVO -->
              <th class="text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="regidoresTableBody" class="sortable-table"></tbody>
        </table>
      </div>
    </div>

    <div class="card-footer text-muted">
      <div id="statusMessageRegidores" class="text-center"></div>
    </div>
  </div>


  <!-- Bot√≥n Director -->
  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
    <a href="{% url 'director_create' %}" class="btn btn-add w-100 mb-3">
      <i class="fa fa-user-plus"></i> Agregar director
    </a>
  </div>

  <!-- DIRECTORES -->
  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Directores</h2>
      <div class="drag-hint">
        <i class="fa fa-info-circle me-2"></i>
        <span>Arrastra las filas para reorganizar</span>
      </div>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="directoresTable">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Cargo</th>
              <th>√Årea</th>
              <th>Estado</th>
              <th class="text-center">Posici√≥n</th>
              <th class="text-center">Usuario</th> <!-- NUEVO -->
              <th class="text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="directoresTableBody" class="sortable-table"></tbody>
        </table>
      </div>
    </div>

    <div class="card-footer text-muted">
      <div id="statusMessageDirectores" class="text-center"></div>
    </div>
  </div>

  <!-- Bot√≥n y lista de Presidentes Comunales -->
  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
    <a href="{% url 'crear-presidente-comu' %}" class="btn btn-add w-100 mb-3">
      <i class="fa fa-user-plus"></i> Agregar Presidente de Comunidad
    </a>
  </div>

  <div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Presidentes de Comunidades</h2>
      <div class="drag-hint">
        <i class="fa fa-info-circle me-2"></i>
        <span>Arrastra las filas para reorganizar</span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="presidentesComuTable">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Cargo</th>
              <th>√Årea</th>
              <th>Estado</th>
              <th class="text-center">Posici√≥n</th>
              <th class="text-center">Usuario</th> <!-- NUEVO -->
              <th class="text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="presidentesComuTableBody" class="sortable-table"></tbody>
        </table>
      </div>
    </div>
    <div class="card-footer text-muted">
      <div id="statusMessagePresidentesComu" class="text-center"></div>
    </div>
  </div>

  <!-- Bot√≥n y lista de Coordinadores DIF -->
  <div class="col-12 col-sm-6 col-md-4 col-lg-3">
    <a href="{% url 'crear-coordinador-dif' %}" class="btn btn-add w-100 mb-3">
      <i class="fa fa-user-plus"></i> Agregar Coordinador DIF
    </a>
  </div>

  <div class="card shadow">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h2 class="mb-0">Coordinadores DIF</h2>
      <div class="drag-hint">
        <i class="fa fa-info-circle me-2"></i>
        <span>Arrastra las filas para reorganizar</span>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="coordinadoresDifTable">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Cargo</th>
              <th>√Årea</th>
              <th>Estado</th>
              <th class="text-center">Posici√≥n</th>
              <th class="text-center">Usuario</th> <!-- NUEVO -->
              <th class="text-center">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="coordinadoresDifTableBody" class="sortable-table"></tbody>
        </table>
      </div>
    </div>
    <div class="card-footer text-muted">
      <div id="statusMessageCoordinadoresDif" class="text-center"></div>
    </div>
  </div>

</div>



<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Patr√≥n para PRE-EDITAR en Gabinete
    const preUrlPatternGabinete = "{% url 'pre_editar_persona' 'gabinete' 99999 %}";
    const userUrlPatternGabinete = "{% url 'asociar_usuario' 'gabinete' 99999 %}"; // NUEVO

    // Carga inicial de datos
    fetchData();

    function fetchData() {
      fetch("{% url 'gabinete_list_api' %}", { method: "GET" })
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById("gabineteTableBody");
          tbody.innerHTML = "";

          data.miembros.forEach(miembro => {
            const row = document.createElement("tr");
            row.setAttribute("data-id", miembro.id);
            row.className = "position-relative";

            let statusClass = miembro.status === "Activo" ? "text-success" : "text-danger";

            // URLs de acci√≥n
            const editUrl = "{% url 'gabinete_edit' 99999 %}".replace("99999", miembro.id);
            const preUrl  = preUrlPatternGabinete.replace("99999", miembro.id);
            const userUrl = userUrlPatternGabinete.replace("99999", miembro.id); // NUEVO

            const userIcon = miembro.tiene_usuario
              ? `<i class="fa fa-user-circle text-success" title="Con usuario${miembro.usuario ? ': ' + miembro.usuario : ''}"></i>`
              : `<i class="fa fa-user-circle text-danger" title="Sin usuario - clic para asociar"></i>`;

            row.innerHTML = `
              <td>${miembro.nombre}</td>
              <td>${miembro.cargo}</td>
              <td>${miembro.area}</td>
              <td><span class="${statusClass}">${miembro.status}</span></td>
              <td class="text-center">${miembro.orden}</td>
              <td class="text-center">
                <a href="${userUrl}" class="text-decoration-none" aria-label="Asociar/ver usuario">
                  ${userIcon}
                </a>
              </td>
              <td class="text-center">
                <a href="${preUrl}" class="me-2 text-decoration-none" title="Perfil / Pre-editar" aria-label="Perfil">
                  <i class="fa fa-id-card"></i>
                </a>
                <a href="${editUrl}" class="me-2 text-decoration-none" title="Editar" aria-label="Editar">
                  <i class="fa fa-edit"></i>
                </a>
                <div class="drag-handle d-inline-block" title="Arrastrar para reordenar" aria-label="Reordenar">
                  <i class="fa fa-th"></i>
                </div>
              </td>
            `;
            tbody.appendChild(row);
          });

          initSortable();
        })
        .catch(error => {
          console.error("Error al cargar datos:", error);
          showStatusMessage("Error al cargar los datos", "danger");
        });
    }

    function showStatusMessage(message, type = "success") {
      const statusDiv = document.getElementById("statusMessage");
      statusDiv.innerHTML = `<div class="alert alert-${type} py-2 mb-0">${message}</div>`;
      statusDiv.classList.add("fade-out");

      setTimeout(() => {
        statusDiv.innerHTML = "";
        statusDiv.classList.remove("fade-out");
      }, 5000);
    }

    function initSortable() {
      let tbody = document.getElementById("gabineteTableBody");

      new Sortable(tbody, {
        animation: 150,
        handle: '.drag-handle',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        onStart: function() { document.body.style.cursor = 'grabbing'; },
        onEnd: function() {
          document.body.style.cursor = 'default';

          let order = [];
          tbody.querySelectorAll("tr").forEach((tr) => order.push(tr.getAttribute("data-id")));

          showStatusMessage("Actualizando posiciones...", "info");

          const params = new URLSearchParams();
          order.forEach(id => params.append('order[]', id));

          fetch("{% url 'gabinete_update_order_api' %}", {
            method: "POST",
            headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/x-www-form-urlencoded"
            },
            body: params
          })
          .then(res => res.json())
          .then(data => {
            showStatusMessage(data.message || "Posiciones actualizadas correctamente");
            fetchData();
          })
          .catch(err => {
            console.error(err);
            showStatusMessage("Error al actualizar posiciones", "danger");
          });
        }
      });
    }
  });
</script>


<script>
  document.addEventListener("DOMContentLoaded", () => {

    /* ---------- CONFIGURACI√ìN PARA CADA TABLA ---------- */
    const tablas = [
      /* Regidores */
      {
        tbodyId:  "regidoresTableBody",
        statusId: "statusMessageRegidores",
        listUrl:  "{% url 'regidores_list_api' %}",
        orderUrl: "{% url 'regidores_update_order_api' %}",
        editUrlPattern: "{% url 'regidor_edit' 99999 %}",
        preUrlPattern:  "{% url 'pre_editar_persona' 'regidor' 99999 %}",
        userUrlPattern: "{% url 'asociar_usuario' 'regidor' 99999 %}", // NUEVO
      },
      /* Directores */
      {
        tbodyId:  "directoresTableBody",
        statusId: "statusMessageDirectores",
        listUrl:  "{% url 'directores_list_api' %}",
        orderUrl: "{% url 'directores_update_order_api' %}",
        editUrlPattern: "{% url 'director_edit' 99999 %}",
        preUrlPattern:  "{% url 'pre_editar_persona' 'director' 99999 %}",
        userUrlPattern: "{% url 'asociar_usuario' 'director' 99999 %}", // NUEVO
      },
      /* Presidentes de Comunidad */
      {
        tbodyId:  "presidentesComuTableBody",
        statusId: "statusMessagePresidentesComu",
        listUrl:  "{% url 'api-presidentes-comu' %}",
        orderUrl: "{% url 'api-update-order-presidentes-comu' %}",
        editUrlPattern: "{% url 'editar-presidente-comu' 99999 %}",
        preUrlPattern:  "{% url 'pre_editar_persona' 'presidente' 99999 %}",
        userUrlPattern: "{% url 'asociar_usuario' 'presidente' 99999 %}", // NUEVO
      },
      /* Coordinadores DIF */
      {
        tbodyId:  "coordinadoresDifTableBody",
        statusId: "statusMessageCoordinadoresDif",
        listUrl:  "{% url 'api-coordinadores-dif' %}",
        orderUrl: "{% url 'api-update-order-coordinadores-dif' %}",
        editUrlPattern: "{% url 'editar-coordinador-dif' 99999 %}",
        preUrlPattern:  "{% url 'pre_editar_persona' 'coordinador_dif' 99999 %}",
        userUrlPattern: "{% url 'asociar_usuario' 'coordinador_dif' 99999 %}", // NUEVO
      },
    ];

    /* ---------- INICIALIZAR CADA TABLA ---------- */
    tablas.forEach(cfg => {
      fetchAndRender(cfg);
    });

    /* ---------- FUNCIONES ---------- */
    function fetchAndRender(cfg){
      fetch(cfg.listUrl)
        .then(r => r.json())
        .then(json => renderRows(json.miembros, cfg))
        .then(()  => initSortable(cfg))
        .catch(()  => showStatus("Error al cargar datos", "danger", cfg));
    }

    function renderRows(rows, cfg){
      const tbody = document.getElementById(cfg.tbodyId);
      tbody.innerHTML = "";

      rows.forEach(m => {
        const tr = document.createElement("tr");
        tr.dataset.id = m.id;

        const stClass = m.status === "Activo" ? "text-success" : "text-danger";
        const editUrl = cfg.editUrlPattern.replace("99999", m.id);
        const preUrl  = cfg.preUrlPattern.replace("99999", m.id);
        const userUrl = cfg.userUrlPattern.replace("99999", m.id); // NUEVO

        const userIcon = m.tiene_usuario
          ? `<i class="fa fa-user-circle text-success" title="Con usuario${m.usuario ? ': ' + m.usuario : ''}"></i>`
          : `<i class="fa fa-user-circle text-danger" title="Sin usuario - clic para asociar"></i>`;

        tr.innerHTML = `
          <td>${m.nombre}</td>
          <td>${m.cargo}</td>
          <td>${m.area}</td>
          <td><span class="${stClass}">${m.status}</span></td>
          <td class="text-center">${m.orden}</td>
          <td class="text-center">
            <a href="${userUrl}" class="text-decoration-none" aria-label="Asociar/ver usuario">
              ${userIcon}
            </a>
          </td>
          <td class="text-center">
            <a href="${preUrl}" class="me-2 text-decoration-none" title="Perfil / Pre-editar" aria-label="Perfil">
              <i class="fa fa-id-card"></i>
            </a>
            <a href="${editUrl}" class="me-2 text-decoration-none" title="Editar" aria-label="Editar">
              <i class="fa fa-edit"></i>
            </a>
            <div class="drag-handle d-inline-block" title="Arrastrar para reordenar" aria-label="Reordenar">
              <i class="fa fa-th"></i>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function initSortable(cfg){
      new Sortable(document.getElementById(cfg.tbodyId), {
        animation: 150,
        handle: '.drag-handle',
        onEnd: () => updateOrder(cfg)
      });
    }

    function updateOrder(cfg){
      const ids = [...document.getElementById(cfg.tbodyId).querySelectorAll("tr")]
                  .map(tr => tr.dataset.id);
      const params = new URLSearchParams();
      ids.forEach(id => params.append('order[]', id));

      showStatus("Actualizando posiciones...", "info", cfg);

      fetch(cfg.orderUrl, {
        method: 'POST',
        headers:{
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: params
      })
      .then(r => r.json())
      .then(j => {
        showStatus(j.message || "Posiciones actualizadas", "success", cfg);
        fetchAndRender(cfg);
      })
      .catch(() => showStatus("Error al actualizar", "danger", cfg));
    }

    function showStatus(msg, type, cfg){
      const div = document.getElementById(cfg.statusId);
      div.innerHTML = `<div class="alert alert-${type} py-2 mb-0">${msg}</div>`;
      setTimeout(() => div.innerHTML = "", 4000);
    }
  });
</script>

{% endblock content %}
