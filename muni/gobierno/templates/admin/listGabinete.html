{% extends "baseTemplate.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Miembros del Gabinete</h2>

    <table class="table table-bordered table-striped" id="gabineteTable">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Cargo</th>
                <th>Área</th>
                <th>Estado</th>
                <th>Posición</th>
            </tr>
        </thead>
        <tbody id="gabineteTableBody">
            <!--
                Aquí se cargarán las filas dinámicamente mediante AJAX.
            -->
        </tbody>
    </table>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



<!-- 2) Incluye jQuery UI después de jQuery -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- 3) (Opcional) Incluye el CSS de jQuery UI para los estilos de arrastre/soltar -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css"/>
<script>
    document.addEventListener("DOMContentLoaded", function() {
      // Carga inicial de datos
      fetchData();
  
      function fetchData() {
        fetch("{% url 'gabinete_list_api' %}", { method: "GET" })
          .then(response => response.json())
          .then(data => {
            const tbody = document.getElementById("gabineteTableBody");
            tbody.innerHTML = "";
  
            data.miembros.forEach(miembro => {
              const row = document.createElement("tr");
              row.setAttribute("data-id", miembro.id);
              row.innerHTML = `
                  <td>${miembro.nombre}</td>
                  <td>${miembro.cargo}</td>
                  <td>${miembro.area}</td>
                  <td>${miembro.status}</td>
                  <td>${miembro.orden}</td>
              `;
              tbody.appendChild(row);
            });
  
            initSortable();
          })
          .catch(error => console.error("Error al cargar datos:", error));
      }
  
      function initSortable() {
        let tbody = document.getElementById("gabineteTableBody");
  
        // Instancia Sortable
        new Sortable(tbody, {
          animation: 150,  // suavidad al arrastrar
          // `onEnd` se dispara cuando termina el arrastre
          onEnd: function (evt) {
            // Obtenemos el nuevo orden de todas las filas
            let order = [];
            tbody.querySelectorAll("tr").forEach((tr) => {
              order.push(tr.getAttribute("data-id"));
            });
  
            // Se envía la nueva lista de IDs a tu vista para actualizar 'orden'
            fetch("{% url 'gabinete_update_order_api' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}", // si usas CSRF en Django
                "Content-Type": "application/x-www-form-urlencoded"
              },
              body: new URLSearchParams({
                "order[]": order
              })
            })
            .then(response => response.json())
            .then(data => {
              console.log(data.message);
              // Recargamos la tabla
              fetchData();
            })
            .catch(error => console.error("Error al actualizar el orden:", error));
          }
        });
      }
    });
  </script>
  

  {% endblock content %}
