{% extends 'base.html' %}
{% load static %}

{% block content %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
/* =========================
   SEVAC LOOK & FEEL (scoped)
   ========================= */
.sevac-wrapper{ padding-bottom: 30px; }

.sevac-wrapper .section-header{
  display:flex; flex-direction:column;
  padding:10px 20px;
  background:transparent;
  position:relative;
  margin-left:0; /* ✅ sin sangría */
}
/* ✅ QUITADO: la barra lateral izquierda */
/* .sevac-wrapper .section-header::before{ ... } */

.sevac-wrapper .header-left{
  background:transparent;
  color:#333;
  padding:20px 10px 8px; /* ✅ más compacto sin logo */
  border-radius:12px;
  box-shadow:none;
  position:relative;
}

/* ✅ QUITADO: logo */
/* .sevac-wrapper .header-left .logo{ ... } */

.sevac-wrapper .header-title1{
  font-size:42px; font-weight:800;
  margin-bottom:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--color-primario);
}
.sevac-wrapper .header-title{
  font-size:28px; font-weight:800;
  margin-bottom:10px;
  letter-spacing:1px;
  text-transform:uppercase;
  color:var(--color-primario);
}
.sevac-wrapper .header-description{
  font-size:16px; font-weight:400;
  color:#6b7280;
  line-height:1.6;
  max-width: 950px;
}

/* Card contenedora */
.sevac-wrapper .card-accordion{
  background:#fff;
  padding:18px;
  border-radius:14px;
  box-shadow:0px 12px 30px rgba(0,0,0,.08);
  border:1px solid rgba(226,232,240,.8);
}

/* Accordion buttons */
.sevac-wrapper .accordion-item{
  border:0 !important;
  background: transparent !important;
}
.sevac-wrapper .accordion-header{ margin-bottom: 8px; }
.sevac-wrapper .accordion-button{
  font-size:15px;
  color:#334155;
  background:#fff;
  border-radius:12px;
  padding:12px 16px;
  border:1px solid rgba(226,232,240,.9);
  box-shadow: 0 1px 0 rgba(15,23,42,.03);
  transition: all .2s ease;
}
.sevac-wrapper .accordion-button:not(.collapsed){
  background:#f8fafc;
  border-color: rgba(226,232,240,.9);
  box-shadow: 0 10px 20px rgba(15,23,42,.05);
}
.sevac-wrapper .accordion-button:focus{
  box-shadow:0 0 0 .2rem rgba(0,0,0,0);
}
.sevac-wrapper .fa-folder{ color:#F6C344; }
.sevac-wrapper .fa-folder-open{ opacity:.95; }

/* filtros */
.sevac-wrapper .filters-container{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  margin:18px 0 22px;
}
.sevac-wrapper .year-filter{ position:relative; display:flex; align-items:center; }
.sevac-wrapper #yearSelect{
  padding:10px 14px;
  width:190px;
  font-size:1rem;
  border-radius:999px;
  border:1px solid #e2e8f0;
  background:#fff;
  appearance:none;
  background-image:url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
  background-repeat:no-repeat;
  background-position:right 12px center;
  cursor:pointer;
}
.sevac-wrapper #yearSelect:focus{
  border-color:var(--color-primario);
  box-shadow:0 0 0 3px rgba(58,98,132,.12);
  outline:none;
}
.sevac-wrapper .search-container{ position:relative; flex: 1; max-width: 520px; }
.sevac-wrapper .search-input{
  padding:10px 14px 10px 40px;
  width:100%;
  font-size:1rem;
  border-radius:999px;
  border:1px solid #e2e8f0;
  transition: all .2s ease;
}
.sevac-wrapper .search-input:focus{
  border-color:var(--color-primario);
  box-shadow:0 0 0 3px rgba(58,98,132,.12);
  outline:none;
}
.sevac-wrapper .search-icon{
  position:absolute;
  left:15px;
  top:50%;
  transform:translateY(-50%);
  color:#94a3b8;
  font-size:15px;
}
@media (max-width:768px){
  .sevac-wrapper .filters-container{ flex-direction:column; align-items:stretch; }
  .sevac-wrapper .search-container{ max-width: 100%; }
  .sevac-wrapper #yearSelect{ width:100%; }
}

/* =========================
   Tarjeta de archivo
   ========================= */
.sevac-wrapper .files-grid{
  display:grid;
  grid-template-columns:repeat(4, minmax(0,1fr));
  gap:14px;
  margin-top:14px;
}
@media (max-width:1200px){ .sevac-wrapper .files-grid{ grid-template-columns:repeat(3, minmax(0,1fr)); } }
@media (max-width:768px){ .sevac-wrapper .files-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
@media (max-width:480px){ .sevac-wrapper .files-grid{ grid-template-columns:1fr; } }

.sevac-wrapper .file-item{
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:flex-start;
  gap:10px;
  padding:14px 14px 12px;
  border-radius:14px;
  background:#ffffff;
  border:1px solid rgba(226,232,240,.9);
  box-shadow: 0 10px 18px rgba(15,23,42,.05);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  min-height: 150px;
}
.sevac-wrapper .file-item:hover{
  transform: translateY(-3px);
  border-color: rgba(58,98,132,.25);
  box-shadow: 0 18px 30px rgba(15,23,42,.08);
}

/* Icono + encabezado */
.sevac-wrapper .file-head{
  display:flex;
  align-items:flex-start;
  gap:10px;
  width:100%;
}
.sevac-wrapper .file-ico{
  width:42px; height:42px;
  border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  background: rgba(148,163,184,.12);
  border:1px solid rgba(148,163,184,.18);
  flex: 0 0 auto;
}
.sevac-wrapper .file-ico i{ font-size:20px; }

/* Título del archivo */
.sevac-wrapper .file-title{
  font-size:14px;
  font-weight:800;
  color:#0f172a;
  line-height:1.25;
  margin:0;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Subtexto */
.sevac-wrapper .file-sub{
  font-size:12px;
  color:#64748b;
  margin-top:4px;
}

/* ✅ META ABAJO (aquí va el año para que no estorbe) */
.sevac-wrapper .file-meta-row{
  margin-top:auto;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding-top:8px;
  border-top:1px solid rgba(226,232,240,.9);
}
.sevac-wrapper .file-meta-left{
  font-size:12px;
  color:#64748b;
}
.sevac-wrapper .file-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  font-weight:800;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(58,98,132,.10);
  color: var(--color-primario);
  border:1px solid rgba(58,98,132,.15);
  white-space:nowrap;
}

/* Link clicable */
.sevac-wrapper .file-link{
  width:100%;
  display:inline-flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-radius:12px;
  background:#f8fafc;
  border:1px solid rgba(226,232,240,.9);
  text-decoration:none;
  color:#0f172a;
  font-size:13px;
  transition: background .18s ease, border-color .18s ease;
}
.sevac-wrapper .file-link:hover{
  background: rgba(58,98,132,.06);
  border-color: rgba(58,98,132,.18);
  color:#0f172a;
}
.sevac-wrapper .file-link .go{
  color: var(--color-primario);
  font-weight:900;
}

/* colores íconos */
.sevac-wrapper .fa-file-pdf{ color:#e63946; }
.sevac-wrapper .fa-file-word{ color:#1e3a8a; }
.sevac-wrapper .fa-file-excel{ color:#10b981; }
.sevac-wrapper .fa-file-powerpoint{ color:#f59e0b; }
.sevac-wrapper .fa-file-alt{ color:#6b7280; }
.sevac-wrapper .fa-image{ color:#4c6ef5; }
.sevac-wrapper .fa-link{ color:var(--color-primario); }

/* Vacío */
.sevac-wrapper .empty-folder{
  color:#94a3b8;
  text-align:center;
  font-size:15px;
  padding:12px;
  border:2px dashed rgba(148,163,184,.35);
  border-radius:14px;
  margin-top:16px;
  font-style:italic;
}

/* portales */
.sevac-wrapper .transparency-section{ background:#f5f5f5; width:100%; padding:40px 0; }
.sevac-wrapper .transparency-access{
  padding:20px; display:flex; justify-content:space-around; flex-wrap:wrap;
  max-width:1200px; margin:0 auto;
}
.sevac-wrapper .transparency-access .access-item{ text-align:center; width:350px; margin:10px; }
.sevac-wrapper .transparency-access .access-item img{
  width:300px; height:200px; object-fit:contain;
  background:#f5f5f5; border-radius:10px;
  transition:transform .3s ease; cursor:pointer;
}
.sevac-wrapper .transparency-access .access-item img:hover{ transform:scale(1.05); }
.sevac-wrapper .dual-text{ text-align:center; font-size:22px; margin-bottom:20px; color:#6b7280; }
.sevac-wrapper .bold-text{ font-weight:700; color:var(--color-primario); }
.sevac-wrapper .light-text{ font-weight:400; color:#6b7280; }
</style>

<div class="sevac-wrapper">
  <div class="container mt-4">
    <div class="section-header">
      <div class="header-left">
        {# ✅ LOGO REMOVIDO COMPLETO #}

        <h1 class="header-title1">TRANSPARENCIA</h1>
        <h2 class="header-title">Carpetas y Archivos</h2>
        <p class="header-description">
          Explora la información por estructura: obligación → artículo → documento.
        </p>
      </div>

      <!-- filtros -->
      <div class="filters-container">
        <div class="year-filter">
          <select id="yearSelect" onchange="applyFiltersSevac()">
            <option value="">Todos los años</option>
            {% for year in years %}
              <option value="{{ year }}">{{ year }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input id="searchInput" class="search-input"
                 type="text" placeholder="Buscar por fracción o nombre del archivo…" onkeyup="applyFiltersSevac()">
        </div>
      </div>

      <!-- acordeones -->
      <div class="card-accordion">
        <div class="accordion" id="obligacionesAccordion">

          {% for lista in lista_obligaciones %}
            <div class="accordion-item sevac-obligacion" id="lista-{{ lista.id }}">
              <h2 class="accordion-header" id="headingLista{{ lista.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseLista{{ lista.id }}"
                        aria-expanded="false"
                        aria-controls="collapseLista{{ lista.id }}">
                  <i class="fas fa-folder me-2"></i>
                  <strong>{{ lista.titulo }}</strong>
                </button>
              </h2>

              <div id="collapseLista{{ lista.id }}" class="accordion-collapse collapse"
                   aria-labelledby="headingLista{{ lista.id }}"
                   data-bs-parent="#obligacionesAccordion">
                <div class="accordion-body">

                  {% if not lista.articulos_liga.all %}
                    <div class="empty-folder">Esta carpeta está vacía.</div>
                  {% else %}

                    <div class="accordion" id="articulosAccordion{{ lista.id }}">
                      {% for articulo in lista.articulos_liga.all %}
                        <div class="accordion-item sevac-articulo" id="articulo-{{ articulo.id }}">
                          <h2 class="accordion-header" id="headingArticulo{{ articulo.id }}">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseArticulo{{ articulo.id }}"
                                    aria-expanded="false"
                                    aria-controls="collapseArticulo{{ articulo.id }}">
                              <i class="fas fa-folder-open text-warning me-2"></i>
                              {{ articulo.articulo_fraccion }}
                            </button>
                          </h2>

                          <div id="collapseArticulo{{ articulo.id }}" class="accordion-collapse collapse"
                               aria-labelledby="headingArticulo{{ articulo.id }}"
                               data-bs-parent="#articulosAccordion{{ lista.id }}">
                            <div class="accordion-body">

                              {% if not articulo.archivos %}
                                <div class="empty-folder">Esta subcarpeta está vacía.</div>
                              {% else %}
                                <div class="files-grid">

                                  {% for archivo in articulo.archivos %}
                                    <div class="file-item sevac-file-item"
                                         data-articulo="{{ articulo.id }}"
                                         data-ano="{{ archivo.ano }}"
                                         data-text="{{ articulo.articulo_fraccion|lower }} {{ archivo.titulo_archivo|default_if_none:''|lower }}">

                                      <div class="file-head">
                                        <div class="file-ico">
                                          {% if archivo.liga %}
                                            <i class="fas fa-link"></i>
                                          {% elif archivo.archivo %}
                                            <i class="fas
                                              {% if archivo.archivo.url|lower|slice:'-4:' == '.pdf' %}
                                                fa-file-pdf
                                              {% elif archivo.archivo.url|lower|slice:'-5:' == '.docx' or archivo.archivo.url|lower|slice:'-4:' == '.doc' %}
                                                fa-file-word
                                              {% elif archivo.archivo.url|lower|slice:'-5:' == '.xlsx' or archivo.archivo.url|lower|slice:'-4:' == '.xls' %}
                                                fa-file-excel
                                              {% elif archivo.archivo.url|lower|slice:'-5:' == '.pptx' or archivo.archivo.url|lower|slice:'-4:' == '.ppt' %}
                                                fa-file-powerpoint
                                              {% elif archivo.archivo.url|lower|slice:'-4:' == '.jpg' or archivo.archivo.url|lower|slice:'-4:' == '.png' or archivo.archivo.url|lower|slice:'-4:' == '.gif' %}
                                                fa-image
                                              {% else %}
                                                fa-file-alt
                                              {% endif %}
                                            "></i>
                                          {% else %}
                                            <i class="fas fa-file-alt"></i>
                                          {% endif %}
                                        </div>

                                        <div style="min-width:0;">
                                          <div class="file-title" title="{{ archivo.titulo_archivo|default:'Documento' }}">
                                            {{ archivo.titulo_archivo|default:"Documento" }}
                                          </div>
                                          <div class="file-sub">
                                            Fracción: <strong>{{ articulo.articulo_fraccion }}</strong>
                                          </div>
                                        </div>
                                      </div>

                                      {% if archivo.liga %}
                                        <a class="file-link" href="{{ archivo.liga }}" target="_blank" rel="noopener">
                                          <span>Abrir enlace</span>
                                          <span class="go">Ver →</span>
                                        </a>
                                      {% elif archivo.archivo %}
                                        <a class="file-link" href="{{ archivo.archivo.url }}" target="_blank" rel="noopener">
                                          <span>Abrir documento</span>
                                          <span class="go">Ver →</span>
                                        </a>
                                      {% else %}
                                        <div class="file-link" style="justify-content:center; opacity:.7;">
                                          Sin documento disponible
                                        </div>
                                      {% endif %}

                                      <!-- ✅ Meta inferior: tipo + año (sin amontonarse arriba) -->
                                      <div class="file-meta-row">
                                        <div class="file-meta-left">
                                          {% if archivo.liga %}Tipo: Liga{% else %}Tipo: Archivo{% endif %}
                                        </div>
                                        {% if archivo.ano %}
                                          <div class="file-chip">
                                            <i class="fas fa-calendar-alt"></i> {{ archivo.ano }}
                                          </div>
                                        {% endif %}
                                      </div>

                                    </div>
                                  {% endfor %}

                                </div>
                              {% endif %}

                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>

                  {% endif %}

                </div>
              </div>
            </div>
          {% endfor %}

        </div>
      </div>

    </div>
  </div>

  <br>

  <div class="transparency-section">
    <div class="access-item">
      <p class="dual-text">
        <span class="bold-text">Realiza tus consultas</span> |
        <span class="light-text">Consulta los portales de transparencia</span>
      </p>
    </div>

    <div class="transparency-access">
      <div class="access-item">
        <a href="https://pruebas.iaiptlaxcala.org.mx/">
          <img class="large-img" src="{% static 'img/aipi.png' %}" alt="Información Pública">
        </a>
      </div>
      <div class="access-item">
        <a href="https://www.plataformadetransparencia.org.mx/Inicio">
          <img src="{% static 'img/Transparencia.png' %}" alt="Indicadores de Resultados">
        </a>
      </div>
      <div class="access-item">
        <a href="https://consultapublicamx.plataformadetransparencia.org.mx/vut-web/faces/view/consultaPublica.xhtml#obligaciones">
          <img src="{% static 'img/ltaip.jpg' %}" alt="Directorio">
        </a>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * 1) Filtra por año y texto (fracción + título).
 * 2) Por cada artículo deja visible SOLO el archivo más reciente (max año)
 *    dentro del resultado filtrado.
 * 3) Oculta subcarpetas (artículos) y carpetas (listas) vacías.
 */
function applyFiltersSevac(){
  const year   = document.getElementById('yearSelect').value;
  const search = (document.getElementById('searchInput').value || '').toLowerCase().trim();

  const items = Array.from(document.querySelectorAll('.sevac-file-item'));

  // Filtro base: año + búsqueda
  items.forEach(item => {
    const itemYear = item.dataset.ano || '';
    const itemText = item.dataset.text || '';
    const yearMatch = !year || itemYear === year;
    const textMatch = !search || itemText.includes(search);
    item.style.display = (yearMatch && textMatch) ? '' : 'none';
  });

  // Agrupa por artículo y deja visible el más reciente dentro de lo visible
  const grupos = {};
  items.forEach(item => {
    if (item.style.display === 'none') return;
    const id = item.dataset.articulo;
    if (!grupos[id]) grupos[id] = [];
    grupos[id].push(item);
  });

  Object.keys(grupos).forEach(id => {
    let best = null;
    let bestYear = -999999;

    grupos[id].forEach(item => {
      const y = parseInt(item.dataset.ano || '-999999', 10);
      if (y > bestYear){
        bestYear = y;
        best = item;
      }
    });

    grupos[id].forEach(item => {
      if (item !== best) item.style.display = 'none';
    });
  });

  // Oculta subcarpetas sin items visibles
  document.querySelectorAll('.sevac-articulo').forEach(art => {
    const visibles = Array.from(art.querySelectorAll('.sevac-file-item'))
      .some(el => getComputedStyle(el).display !== 'none');
    art.style.display = visibles ? '' : 'none';
  });

  // Oculta carpetas principales sin subcarpetas visibles
  document.querySelectorAll('.sevac-obligacion').forEach(lista => {
    const visibles = Array.from(lista.querySelectorAll('.sevac-articulo'))
      .some(el => getComputedStyle(el).display !== 'none');
    lista.style.display = visibles ? '' : 'none';
  });
}

document.addEventListener('DOMContentLoaded', applyFiltersSevac);
</script>
{% endblock %}
